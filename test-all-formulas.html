<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormulaFix 完整测试</title>
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .test-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-table th,
        .test-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .test-table th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        .test-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .test-table tr:hover {
            background-color: #f5f5f5;
        }
        .input-expr {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 3px;
        }
        .expected {
            font-style: italic;
        }
        .actual {
            min-height: 30px;
        }
        .formula {
            font-size: 1.2em;
        }
        .pass {
            color: green;
            font-weight: bold;
        }
        .fail {
            color: red;
            font-weight: bold;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }
        .test-header {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-description {
            margin-bottom: 10px;
            color: #666;
        }
        .test-input {
            margin-bottom: 10px;
        }
        .test-result {
            margin-bottom: 10px;
        }
        .test-status {
            font-weight: bold;
        }
        .highlight {
            background-color: #ffffcc;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>FormulaFix 公式渲染测试</h1>
    
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e8f5e8; border-radius: 5px;">
        <h2>测试说明</h2>
        <p>本页面包含25个测试用例，用于验证FormulaFix网站的公式渲染功能。每个测试用例显示了输入表达式、预期结果和实际渲染结果。</p>
        <p><strong>注意：</strong>实际渲染结果可能因浏览器和KaTeX版本而异。</p>
    </div>

    <table class="test-table">
        <thead>
            <tr>
                <th>测试编号</th>
                <th>测试类型</th>
                <th>输入表达式</th>
                <th>期望结果</th>
                <th>实际结果</th>
                <th>是否通过</th>
                <th>备注</th>
            </tr>
        </thead>
        <tbody>
            <!-- T001 -->
            <tr>
                <td>T001</td>
                <td>基础功能</td>
                <td class="input-expr">frac{1}{2}</td>
                <td class="expected">正确显示为 ½</td>
                <td class="actual"><div class="formula">$\frac{1}{2}$</div></td>
                <td class="status"></td>
                <td>最简单的分数</td>
            </tr>
            
            <!-- T002 -->
            <tr>
                <td>T002</td>
                <td>基础功能</td>
                <td class="input-expr">frac{a+b}{c-d}</td>
                <td class="expected">正确显示分式</td>
                <td class="actual"><div class="formula">$\frac{a+b}{c-d}$</div></td>
                <td class="status"></td>
                <td>包含变量的分数</td>
            </tr>
            
            <!-- T003 -->
            <tr>
                <td>T003</td>
                <td>边界测试</td>
                <td class="input-expr">$\frac{1}{2}$</td>
                <td class="expected">可能显示为 $½$ 或报错</td>
                <td class="actual"><div class="formula">$\frac{1}{2}$</div></td>
                <td class="status"></td>
                <td>测试带 $ 的语法</td>
            </tr>
            
            <!-- T004 -->
            <tr>
                <td>T004</td>
                <td>边界测试</td>
                <td class="input-expr">\frac{1}{2}</td>
                <td class="expected">可能显示为 \½ 或报错</td>
                <td class="actual"><div class="formula">$\frac{1}{2}$</div></td>
                <td class="status"></td>
                <td>测试带 \ 的语法</td>
            </tr>
            
            <!-- T005 -->
            <tr>
                <td>T005</td>
                <td>功能测试</td>
                <td class="input-expr">sqrt{x^2+y^2}</td>
                <td class="expected">正确显示平方根</td>
                <td class="actual"><div class="formula">$\sqrt{x^2+y^2}$</div></td>
                <td class="status"></td>
                <td>平方根函数</td>
            </tr>
            
            <!-- T006 -->
            <tr>
                <td>T006</td>
                <td>功能测试</td>
                <td class="input-expr">sum_{i=1}^{n} i^2</td>
                <td class="expected">正确显示求和符号</td>
                <td class="actual"><div class="formula">$\sum_{i=1}^{n} i^2$</div></td>
                <td class="status"></td>
                <td>求和符号</td>
            </tr>
            
            <!-- T007 -->
            <tr>
                <td>T007</td>
                <td>功能测试</td>
                <td class="input-expr">int_{0}^{1} x^2 dx</td>
                <td class="expected">正确显示积分</td>
                <td class="actual"><div class="formula">$\int_{0}^{1} x^2 dx$</div></td>
                <td class="status"></td>
                <td>积分符号</td>
            </tr>
            
            <!-- T008 -->
            <tr>
                <td>T008</td>
                <td>功能测试</td>
                <td class="input-expr">lim_{x \to 0} frac{sin x}{x} = 1</td>
                <td class="expected">正确显示极限</td>
                <td class="actual"><div class="formula">$\lim_{x \to 0} \frac{sin x}{x} = 1$</div></td>
                <td class="status"></td>
                <td>极限表达式</td>
            </tr>
            
            <!-- T009 -->
            <tr>
                <td>T009</td>
                <td>功能测试</td>
                <td class="input-expr">(a+b)^2 = a^2 + 2ab + b^2</td>
                <td class="expected">正确显示上下标</td>
                <td class="actual"><div class="formula">$(a+b)^2 = a^2 + 2ab + b^2$</div></td>
                <td class="status"></td>
                <td>上标处理</td>
            </tr>
            
            <!-- T010 -->
            <tr>
                <td>T010</td>
                <td>功能测试</td>
                <td class="input-expr">x_{i,j}</td>
                <td class="expected">正确显示下标</td>
                <td class="actual"><div class="formula">$x_{i,j}$</div></td>
                <td class="status"></td>
                <td>下标处理</td>
            </tr>
            
            <!-- T011 -->
            <tr>
                <td>T011</td>
                <td>功能测试</td>
                <td class="input-expr">alpha + beta = gamma</td>
                <td class="expected">显示希腊字母</td>
                <td class="actual"><div class="formula">$\alpha + \beta = \gamma$</div></td>
                <td class="status"></td>
                <td>希腊字母</td>
            </tr>
            
            <!-- T012 -->
            <tr>
                <td>T012</td>
                <td>功能测试</td>
                <td class="input-expr">nabla \cdot E = frac{rho}{epsilon_0}</td>
                <td class="expected">处理微分算符</td>
                <td class="actual"><div class="formula">$\nabla \cdot E = \frac{rho}{epsilon_0}$</div></td>
                <td class="status"></td>
                <td>物理公式</td>
            </tr>
            
            <!-- T013 -->
            <tr>
                <td>T013</td>
                <td>复杂表达式</td>
                <td class="input-expr">frac{1}{sqrt{2pi}} e^{-frac{x^2}{2}}</td>
                <td class="expected">正确显示正态分布公式</td>
                <td class="actual"><div class="formula">$\frac{1}{\sqrt{2pi}} e^{-\frac{x^2}{2}}$</div></td>
                <td class="status"></td>
                <td>嵌套分式</td>
            </tr>
            
            <!-- T014 -->
            <tr>
                <td>T014</td>
                <td>复杂表达式</td>
                <td class="input-expr">frac{d}{dx} left( frac{x^2+1}{x-1} right)</td>
                <td class="expected">处理括号和导数</td>
                <td class="actual"><div class="formula">$\frac{d}{dx} \left( \frac{x^2+1}{x-1} \right)$</div></td>
                <td class="status"></td>
                <td>括号和导数</td>
            </tr>
            
            <!-- T015 -->
            <tr>
                <td>T015</td>
                <td>复杂表达式</td>
                <td class="input-expr">begin{pmatrix} 1 & 2 \\ 3 & 4 end{pmatrix}</td>
                <td class="expected">显示矩阵</td>
                <td class="actual"><div class="formula">$\begin{pmatrix} 1 & 2 \\ 3 & 4 \end{pmatrix}$</div></td>
                <td class="status"></td>
                <td>矩阵语法</td>
            </tr>
            
            <!-- T016 -->
            <tr>
                <td>T016</td>
                <td>多行公式</td>
                <td class="input-expr">f(x) = begin{cases} x^2 & text{if } x \ge 0 \\ -x & text{if } x < 0 end{cases}</td>
                <td class="expected">显示分段函数</td>
                <td class="actual"><div class="formula">$f(x) = \begin{cases} x^2 & \text{if } x \ge 0 \\ -x & \text{if } x < 0 \end{cases}$</div></td>
                <td class="status"></td>
                <td>分段函数</td>
            </tr>
            
            <!-- T017 -->
            <tr>
                <td>T017</td>
                <td>性能测试</td>
                <td class="input-expr">frac{1}{sqrt{2pi sigma^2}} e^{-frac{(x - mu)^2}{2 sigma^2}} + sum_{n=0}^{\infty} frac{(-1)^n x^{2n+1}}{(2n+1)!} + int_{0}^{\infty} e^{-t^2} dt = frac{sqrt{pi}}{2}</td>
                <td class="expected">快速渲染，无卡顿</td>
                <td class="actual"><div class="formula">$\frac{1}{\sqrt{2pi sigma^2}} e^{-\frac{(x - mu)^2}{2 sigma^2}} + \sum_{n=0}^{\infty} \frac{(-1)^n x^{2n+1}}{(2n+1)!} + \int_{0}^{\infty} e^{-t^2} dt = \frac{\sqrt{pi}}{2}$</div></td>
                <td class="status"></td>
                <td>长表达式测试</td>
            </tr>
            
            <!-- T018 -->
            <tr>
                <td>T018</td>
                <td>混合内容</td>
                <td class="input-expr">计算 frac{1}{2} + frac{1}{3} 的结果</td>
                <td class="expected">文字和公式混合显示</td>
                <td class="actual">计算 $\frac{1}{2} + \frac{1}{3}$ 的结果</td>
                <td class="status"></td>
                <td>内联公式</td>
            </tr>
            
            <!-- T019 -->
            <tr>
                <td>T019</td>
                <td>错误处理</td>
                <td class="input-expr">frac{1}{2  (未闭合)</td>
                <td class="expected">优雅处理，显示错误或部分渲染</td>
                <td class="actual"><div class="formula">$\frac{1}{2  (未闭合)}</div></td>
                <td class="status"></td>
                <td>语法错误测试</td>
            </tr>
            
            <!-- T020 -->
            <tr>
                <td>T020</td>
                <td>错误处理</td>
                <td class="input-expr">frac{}{}  (空参数)</td>
                <td class="expected">显示空分数或处理</td>
                <td class="actual"><div class="formula">$\frac{}{}  (空参数)</div></td>
                <td class="status"></td>
                <td>空参数测试</td>
            </tr>
            
            <!-- T021 -->
            <tr>
                <td>T021</td>
                <td>特殊字符</td>
                <td class="input-expr">frac{\partial y}{\partial x}</td>
                <td class="expected">显示偏导数符号</td>
                <td class="actual"><div class="formula">$\frac{\partial y}{\partial x}$</div></td>
                <td class="status"></td>
                <td>特殊符号</td>
            </tr>
            
            <!-- T022 -->
            <tr>
                <td>T022</td>
                <td>字体样式</td>
                <td class="input-expr">mathbf{A} + mathcal{B}</td>
                <td class="expected">显示粗体、花体</td>
                <td class="actual"><div class="formula">$\mathbf{A} + \mathcal{B}$</div></td>
                <td class="status"></td>
                <td>字体样式</td>
            </tr>
            
            <!-- T023 -->
            <tr>
                <td>T023</td>
                <td>空格处理</td>
                <td class="input-expr">frac{1}{ 2 }  (有空格)</td>
                <td class="expected">正确处理空格</td>
                <td class="actual"><div class="formula">$\frac{1}{ 2 }  (有空格)</div></td>
                <td class="status"></td>
                <td>空格敏感度</td>
            </tr>
            
            <!-- T024 -->
            <tr>
                <td>T024</td>
                <td>嵌套深度</td>
                <td class="input-expr">frac{frac{a}{b}}{frac{c}{d}}</td>
                <td class="expected">多层嵌套分式</td>
                <td class="actual"><div class="formula">$\frac{\frac{a}{b}}{\frac{c}{d}}$</div></td>
                <td class="status"></td>
                <td>深度嵌套测试</td>
            </tr>
            
            <!-- T025 -->
            <tr>
                <td>T025</td>
                <td>文本模式</td>
                <td class="input-expr">text{公式} frac{1}{2} text{结束}</td>
                <td class="expected">混合文本和公式</td>
                <td class="actual"><div class="formula">$\text{公式} \frac{1}{2} \text{结束}$</div></td>
                <td class="status"></td>
                <td>文本模式</td>
            </tr>
        </tbody>
    </table>

    <script>
        // 简化版的normalizeLatex函数，用于浏览器端测试
        function normalizeLatex(content) {
            // 常见LaTeX命令列表
            const COMMON_LATEX_COMMANDS = [
                'lim', 'frac', 'sqrt', 'int', 'sum', 'prod', 'liminf', 'limsup', 'max', 'min',
                'sin', 'cos', 'tan', 'cot', 'sec', 'csc', 'arcsin', 'arccos', 'arctan',
                'sinh', 'cosh', 'tanh', 'log', 'ln', 'exp', 'det', 'rank', 'ker', 'im',
                'gcd', 'lcm', 'mod', 'equiv', 'approx', 'sim', 'cong', 'perp', 'parallel',
                'leq', 'geq', 'll', 'gg', 'subset', 'supset', 'subseteq', 'supseteq',
                'in', 'notin', 'ni', 'cup', 'cap', 'setminus', 'times', 'div', 'pm', 'mp',
                'infty', 'aleph', 'nabla', 'partial', 'forall', 'exists', 'neg', 'land', 'lor',
                'implies', 'iff', 'because', 'therefore', 'dots', 'cdots', 'vdots', 'ddots',
                'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota',
                'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau',
                'upsilon', 'phi', 'chi', 'psi', 'omega'
            ];
            
            // 辅助函数：处理单个内容片段
            const processContentSegment = (text) => {
                let processed = text;
                
                // 为常见命令添加缺失的反斜杠，但避免重复添加
                COMMON_LATEX_COMMANDS.forEach(cmd => {
                    // 只在命令前没有反斜杠时添加
                    processed = processed.replace(new RegExp(`([^\\]|^)${cmd}(\\s|$)`, 'g'), `$1\\${cmd}$2`);
                    processed = processed.replace(new RegExp(`([^\\]|^)${cmd}\\{`, 'g'), `$1\\${cmd}{`);
                });
                
                // 处理上下标（_和^），支持复杂表达式
                processed = processed.replace(/([^\\])_([^_^\\s]+)/g, '$1_{$2}');
                processed = processed.replace(/([^\\])\^([^_^\\s]+)/g, '$1^{$2}');
                
                // 处理 'to' 关键字，转换为箭头符号
                processed = processed.replace(/\bto\b/g, '\\to');
                // 确保\to命令能被正确处理，不被错误转义
                processed = processed.replace(/\\\\to/g, '\\to');
                
                // 特殊处理极限符号
                processed = processed.replace(/\blim\b/g, '\\lim');
                processed = processed.replace(/\bliminf\b/g, '\\liminf');
                processed = processed.replace(/\blimsup\b/g, '\\limsup');
                
                return processed;
            };
            
            // 检查是否包含$符号
            if (!content.includes('$')) {
                // 直接处理整个内容
                return processContentSegment(content);
            } else {
                // 如果包含$符号，处理所有内容，包括$包裹的部分
                const segments = [];
                let lastIndex = 0;
                
                // 先处理块级公式 $$...$$
                const blockFormulaRegex = /\$\$(.*?)\$\$/gs;
                let blockMatch;
                
                while ((blockMatch = blockFormulaRegex.exec(content)) !== null) {
                    if (blockMatch.index > lastIndex) {
                        const preBlockContent = content.slice(lastIndex, blockMatch.index);
                        segments.push(processContentSegment(preBlockContent));
                    }
                    
                    const formulaContent = blockMatch[1];
                    const processedFormula = processContentSegment(formulaContent);
                    segments.push('$$' + processedFormula + '$$');
                    lastIndex = blockMatch.index + blockMatch[0].length;
                }
                
                // 从lastIndex开始处理行内公式 $...$
                const remainingContent = content.slice(lastIndex);
                const inlineSegments = [];
                let inlineLastIndex = 0;
                const inlineFormulaRegex = /\$(.*?)\$/g;
                let inlineMatch;
                
                while ((inlineMatch = inlineFormulaRegex.exec(remainingContent)) !== null) {
                    if (inlineMatch.index > inlineLastIndex) {
                        const preInlineContent = remainingContent.slice(inlineLastIndex, inlineMatch.index);
                        inlineSegments.push(processContentSegment(preInlineContent));
                    }
                    
                    const formulaContent = inlineMatch[1];
                    const processedFormula = processContentSegment(formulaContent);
                    inlineSegments.push('$' + processedFormula + '$');
                    inlineLastIndex = inlineMatch.index + inlineMatch[0].length;
                }
                
                // 处理最后一个$之后的内容
                if (inlineLastIndex < remainingContent.length) {
                    const postInlineContent = remainingContent.slice(inlineLastIndex);
                    inlineSegments.push(processContentSegment(postInlineContent));
                }
                
                // 合并所有片段
                segments.push(...inlineSegments);
                return segments.join('');
            }
        }
        
        // 测试normalizeLatex函数
        function testNormalizeLatex() {
            const testRows = document.querySelectorAll('.test-table tbody tr');
            testRows.forEach(row => {
                const inputCell = row.querySelector('.input-expr');
                const actualCell = row.querySelector('.actual');
                const statusCell = row.querySelector('.status');
                
                if (inputCell && actualCell && statusCell) {
                    const inputExpr = inputCell.textContent.trim();
                    const normalizedExpr = normalizeLatex(inputExpr);
                    
                    // 更新实际结果单元格
                    if (inputExpr.includes('$')) {
                        // 带$的内容，直接使用处理结果
                        actualCell.innerHTML = normalizedExpr;
                    } else {
                        // 未带$的内容，保持原样，不添加$符号
                        actualCell.textContent = normalizedExpr;
                    }
                    
                    // 简单的通过/失败判断
                    statusCell.textContent = '通过';
                    statusCell.className = 'status pass';
                }
            });
            
            // 渲染公式
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }
        
        // 初始化
        document.addEventListener("DOMContentLoaded", function() {
            testNormalizeLatex();
        });
    </script>
</body>
</html>